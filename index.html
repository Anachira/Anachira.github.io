<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SEAT WARS: SYSTEM ONLINE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Kosugi+Maru&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config Handling ---
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Firebase Config Error:", e);
            firebaseConfig = { apiKey: "error", authDomain: "error", projectId: "error" };
        }

        // Global Variables Definition
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.BATTLE_DOC_ID = 'class_2-6_war_v7_multihack'; // FIX: Make global

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Expose to window for app logic
        window.db = db;
        window.auth = auth;
        window.doc = doc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.collection = collection;
        window.serverTimestamp = serverTimestamp;

        // Auth Flow
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                window.updateConnectionStatus(true);
            } catch (error) {
                console.error("Auth Error:", error);
                window.updateConnectionStatus(false);
            }
        };
        initAuth();

        // FIX: Make global to avoid ReferenceError
        window.updateConnectionStatus = function(isOnline) {
            const el = document.getElementById('sys-status');
            if (el) {
                el.textContent = isOnline ? "SYSTEM ONLINE" : "OFFLINE";
                el.className = isOnline ? "text-[10px] text-green-400 font-tech" : "text-[10px] text-red-500 font-tech animate-pulse";
            }
        }

        // Listeners
        onAuthStateChanged(auth, (user) => {
            if (!user) return;
            window.updateConnectionStatus(true);
            
            // 1. Seat Data Listener
            const seatsDocRef = doc(db, 'artifacts', window.appId, 'public', 'data', 'seats_data', window.BATTLE_DOC_ID);
            onSnapshot(seatsDocRef, (snap) => {
                if (snap.exists()) {
                    window.updateBattleField(snap.data().seats);
                } else {
                    window.initializeFieldData();
                }
            }, (err) => {
                console.error("Seat Listener Error:", err);
                window.updateConnectionStatus(false);
            });

            // 2. Chat Data Listener
            const chatsCollectionRef = collection(db, 'artifacts', window.appId, 'public', 'data', 'seat_battle_chats');
            const q = query(chatsCollectionRef, orderBy("timestamp", "desc"), limit(50));
            onSnapshot(q, (snapshot) => {
                const chats = [];
                snapshot.forEach(d => chats.push(d.data()));
                window.updateChatLog(chats);
            });
        });
    </script>

    <style>
        :root {
            --neon-blue: #00f0ff;
            --neon-green: #0aff0a;
            --neon-yellow: #fcee0a;
            --neon-red: #ff003c;
            --neon-purple: #bc13fe;
            --bg-dark: #050505;
        }

        body {
            font-family: 'Kosugi Maru', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        .cyber-grid {
            position: fixed;
            top: 0; left: 0; width: 200%; height: 200%;
            background-image: 
                linear-gradient(rgba(188, 19, 254, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(188, 19, 254, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: grid-move 30s linear infinite;
            z-index: -1;
            pointer-events: none;
        }
        @keyframes grid-move {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(40px) translateZ(-200px); }
        }

        .font-tech { font-family: 'Share Tech Mono', monospace; }
        .font-impact { font-family: 'Black Ops One', cursive; }

        .glass-panel {
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Seat Styles */
        .seat-card {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        .seat-card:active { transform: scale(0.95); }
        
        .seat-taken-me {
            border: 2px solid var(--neon-blue);
            background: rgba(0, 240, 255, 0.15);
            box-shadow: 0 0 15px var(--neon-blue);
        }
        .seat-taken-enemy {
            border: 1px solid #555;
            background: rgba(50, 50, 50, 0.5);
        }
        .seat-shielded {
            border: 2px solid var(--neon-green) !important;
            background: rgba(10, 255, 10, 0.1) !important;
            box-shadow: 0 0 10px var(--neon-green), inset 0 0 5px var(--neon-green);
        }
        .seat-vulnerable {
            border: 2px solid var(--neon-red) !important;
            background: rgba(255, 0, 60, 0.1) !important;
        }
        .seat-empty {
            border: 1px dashed #444;
            background: rgba(0,0,0,0.3);
        }

        .shield-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #333;
        }
        .shield-bar {
            height: 100%;
            background: var(--neon-green);
            width: 100%;
            transition: width 1s linear;
        }

        /* AP Gauge */
        .ap-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 4px;
            z-index: 50;
        }
        .ap-block {
            width: 30px;
            height: 10px;
            background: #333;
            border: 1px solid #555;
            transform: skewX(-20deg);
            transition: all 0.3s;
        }
        .ap-block.active {
            background: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue);
            border-color: #fff;
        }

        .screen {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            flex-direction: column;
        }
        .screen.active { display: flex; }

        /* Hack Game UI */
        .hack-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 60;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .hack-content-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        
        /* Timing Game */
        .hack-bar-container {
            width: 80%;
            height: 40px;
            background: #111;
            border: 2px solid #333;
            position: relative;
            margin: 20px 0;
            overflow: hidden;
            border-radius: 4px;
        }
        .hack-target-zone {
            position: absolute;
            top: 0;
            height: 100%;
            background: var(--neon-red);
            box-shadow: 0 0 15px var(--neon-red);
        }
        .hack-cursor {
            position: absolute;
            top: -5px;
            height: 50px;
            width: 4px;
            background: #fff;
            box-shadow: 0 0 10px #fff;
        }

        /* Rapid Game */
        .rapid-gauge-container {
            width: 60%;
            height: 200px;
            background: #111;
            border: 2px solid #444;
            position: relative;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .rapid-gauge-fill {
            width: 100%;
            background: linear-gradient(to top, #ff003c, #fcee0a);
            height: 0%;
            transition: height 0.05s linear;
        }
        .rapid-target-line {
            position: absolute;
            top: 20%;
            left: 0;
            width: 100%;
            border-top: 2px dashed #fff;
            text-align: right;
        }

        /* Memory Game */
        .memory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .memory-btn {
            width: 80px;
            height: 80px;
            background: #222;
            border: 2px solid #444;
            border-radius: 8px;
            transition: all 0.1s;
        }
        .memory-btn.flash {
            background: #fff;
            box-shadow: 0 0 20px #fff;
            border-color: #fff;
        }
        .memory-btn:active {
            transform: scale(0.95);
        }

        .hack-stage-indicator {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .hack-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
            border: 1px solid #555;
        }
        .hack-dot.active { background: var(--neon-yellow); box-shadow: 0 0 10px var(--neon-yellow); border-color: #fff; }
        .hack-dot.done { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); border-color: #fff; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-blue); }

        .glitch-text { animation: glitch-skew 1s infinite linear alternate-reverse; }
        @keyframes glitch-skew {
            0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 60% { transform: skew(0deg); } 80% { transform: skew(1deg); } 100% { transform: skew(0deg); }
        }
    </style>
</head>
<body>

    <div class="cyber-grid"></div>

    <!-- Intro -->
    <div id="screen-intro" class="screen active justify-center items-center z-50 bg-black">
        <div class="relative w-full max-w-lg text-center">
            <div class="font-tech text-neon-purple text-sm mb-2 tracking-[0.5em] opacity-0" id="intro-sub">PROJECT: CLASS 2-6 v7</div>
            <h1 class="font-impact text-6xl md:text-8xl text-white mb-4 glitch-text opacity-0" id="intro-title">SEAT WARS</h1>
            <p class="text-neon-green font-bold text-sm mb-8 tracking-widest opacity-0" id="intro-ver">PROTOCOL: MULTI-VECTOR ATTACK</p>
            <button id="start-btn" class="hidden mt-12 px-8 py-4 border-2 border-white text-white font-bold tracking-widest hover:bg-white hover:text-black transition-all duration-300 font-tech mx-auto group relative overflow-hidden">
                <span class="relative z-10">INITIALIZE</span>
                <div class="absolute top-0 left-0 w-full h-full bg-purple-600 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-200"></div>
            </button>
        </div>
    </div>

    <!-- Char Select -->
    <div id="screen-char-select" class="screen justify-center items-center z-40 bg-black/90">
        <div class="w-full max-w-3xl p-6 h-full flex flex-col">
            <h2 class="text-3xl font-impact text-purple-400 mb-2 text-center">SELECT IDENTITY</h2>
            <div class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-4 gap-4 p-2" id="char-grid"></div>
        </div>
    </div>

    <!-- Battle -->
    <div id="screen-battle" class="screen z-30">
        <header class="h-16 glass-panel flex justify-between items-center px-4 border-b border-gray-700 shrink-0">
            <div>
                <div id="sys-status" class="text-[10px] text-gray-400 font-tech animate-pulse">CONNECTING...</div>
                <div class="text-xl font-impact text-purple-500 tracking-wider">SEAT WARS</div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-purple-400 font-tech">PILOT</div>
                <div id="my-name-display" class="font-bold text-white">UNKNOWN</div>
            </div>
        </header>

        <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
            <!-- Left: Battlefield -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col items-center justify-center relative bg-gradient-to-b from-transparent to-purple-900/10">
                <div class="w-2/3 h-8 bg-gray-800 border border-gray-600 mb-8 flex items-center justify-center text-gray-500 text-xs font-tech tracking-widest">
                    BLACKBOARD AREA
                </div>
                <div id="seat-container" class="grid grid-cols-6 gap-2 md:gap-4 w-full max-w-4xl aspect-[4/3]"></div>
            </div>

            <!-- AP Gauge -->
            <div class="ap-container">
                <div class="text-xs font-tech text-gray-400 self-center mr-2">AP</div>
                <div id="ap-1" class="ap-block active"></div>
                <div id="ap-2" class="ap-block active"></div>
                <div id="ap-3" class="ap-block active"></div>
            </div>

            <!-- Right: Logs & Chat -->
            <div class="h-1/3 md:h-full md:w-80 glass-panel border-t md:border-t-0 md:border-l border-gray-700 flex flex-col">
                <div class="flex border-b border-gray-700">
                    <button onclick="switchTab('log')" id="tab-log" class="flex-1 py-2 text-xs font-bold text-center bg-gray-800 text-gray-400">LOG</button>
                    <button onclick="switchTab('chat')" id="tab-chat" class="flex-1 py-2 text-xs font-bold text-center bg-gray-900 text-blue-400 border-b-2 border-blue-400">CHAT</button>
                </div>
                <div id="panel-chat" class="flex-1 flex flex-col overflow-hidden">
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-2 space-y-2 font-xs"></div>
                    <div class="p-2 bg-black border-t border-gray-800 flex gap-2">
                        <input type="text" id="chat-input" class="flex-1 bg-gray-900 border border-gray-700 text-white text-sm px-3 py-2 outline-none focus:border-blue-500" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏..." onkeypress="if(event.key === 'Enter') sendChat()">
                        <button onclick="sendChat()" class="bg-blue-600 text-white px-4 font-bold text-xs hover:bg-blue-500">SEND</button>
                    </div>
                </div>
                <div id="panel-log" class="flex-1 flex flex-col overflow-hidden hidden bg-black/50">
                    <div id="log-messages" class="flex-1 overflow-y-auto p-2 space-y-1 font-tech text-xs text-green-400"></div>
                </div>
            </div>
        </div>
        <button onclick="toggleRules()" class="absolute bottom-4 left-4 w-10 h-10 rounded-full border border-white text-white flex items-center justify-center font-bold hover:bg-white hover:text-black z-50 text-lg">?</button>
    </div>

    <!-- Hack Mini Game Modal -->
    <div id="hack-ui" class="hack-overlay">
        <h2 id="hack-title" class="text-3xl font-impact text-white mb-2 glitch-text">BREACH PROTOCOL</h2>
        <p id="hack-desc" class="text-purple-300 font-tech text-xs mb-8">LOADING...</p>
        
        <div class="hack-stage-indicator">
            <div id="hack-stage-1" class="hack-dot active"></div>
            <div id="hack-stage-2" class="hack-dot"></div>
            <div id="hack-stage-3" class="hack-dot"></div>
        </div>

        <div id="hack-game-area" class="hack-content-area">
            <!-- Dynamic Content -->
        </div>
        
        <button id="hack-btn" class="mt-8 px-12 py-6 bg-red-600 text-white font-bold text-xl border-2 border-red-400 hover:bg-red-500 active:scale-95 transition-transform font-tech shadow-[0_0_20px_rgba(255,0,0,0.5)]">
            EXECUTE
        </button>
    </div>

    <!-- Hack Confirm Modal -->
    <div id="modal-hack-confirm" class="fixed inset-0 bg-black/90 z-[100] hidden items-center justify-center p-4">
        <div class="max-w-md w-full glass-panel p-6 border border-red-500 relative shadow-[0_0_30px_rgba(255,0,0,0.3)]">
            <h3 class="text-xl font-impact text-red-500 mb-4">BREACH DETECTED</h3>
            <p class="text-gray-300 mb-4">„Çø„Éº„Ç≤„ÉÉ„Éà„ÅØ<span class="text-green-400">„Ç∑„Éº„É´„Éâ‰øùË≠∑</span>„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br>„Éè„ÉÉ„Ç≠„É≥„Ç∞„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü</p>
            <div class="bg-gray-900 p-3 mb-6 rounded border border-gray-700">
                <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span>REQ. AP</span>
                    <span>TYPE</span>
                </div>
                <div class="flex justify-between font-bold">
                    <span class="text-blue-400">2 AP</span>
                    <span class="text-purple-400">RANDOM</span>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="closeHackConfirm()" class="flex-1 py-3 border border-gray-600 text-gray-400 hover:bg-gray-800 font-tech">ABORT</button>
                <button id="btn-hack-start" class="flex-1 py-3 bg-red-600 text-white font-bold hover:bg-red-500 font-tech shadow-[0_0_10px_rgba(255,0,0,0.5)]">INITIATE</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-rules" class="fixed inset-0 bg-black/90 z-[100] hidden items-center justify-center p-4" onclick="toggleRules()">
        <div class="max-w-md w-full glass-panel p-6 border border-purple-500 relative" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-impact text-purple-500 mb-4">RULES v7</h3>
            <ul class="list-disc pl-5 space-y-3 text-sm text-gray-300">
                <li><strong class="text-green-400">„Ç∑„Éº„É´„ÉâÔºà3ÂàÜÔºâ:</strong> Â∏≠Á¢∫‰øùÂæå„ÅÆ3ÂàÜÈñì„ÅØÈÄöÂ∏∏ÊâãÊÆµ„Åß„ÅØÂ•™„Çè„Çå„Å™„ÅÑ„ÄÇ</li>
                <li><strong class="text-red-400">„É©„É≥„ÉÄ„É†„Éè„ÉÉ„ÇØ:</strong> „Ç∑„Éº„É´„Éâ‰∏≠„ÅÆÂ∏≠„ÅØ„Éè„ÉÉ„Ç≠„É≥„Ç∞„ÅßÂº∑Â•™ÂèØËÉΩÔºà2 APÔºâ„ÄÇ„Éü„Éã„Ç≤„Éº„É†„ÅØ3Á®ÆÈ°û„Åã„Çâ„É©„É≥„ÉÄ„É†„ÅßÈÅ∏„Å∞„Çå„Çã„ÄÇ</li>
                <li><strong class="text-purple-400">„Éü„Éã„Ç≤„Éº„É†:</strong><br>
                    üîµ <strong>MEMORY:</strong> ÂÖâ„ÇãÈ†ÜÁï™„ÇíË¶ö„Åà„Çç<br>
                    üî¥ <strong>RAPID:</strong> „Ç≤„Éº„Ç∏„ÅåÂ∞Ω„Åç„ÇãÂâç„Å´ÈÄ£Êâì„Åó„Çç<br>
                    üü£ <strong>TIMING:</strong> Ëµ§„ÅÑ„Çæ„Éº„É≥„ÅßÊ≠¢„ÇÅ„Çç
                </li>
            </ul>
        </div>
    </div>

    <div id="modal-confirm" class="fixed inset-0 bg-black/80 z-[100] hidden items-center justify-center p-4">
        <div class="max-w-md w-full glass-panel p-6 border border-blue-500 relative">
            <h3 class="text-xl font-impact text-blue-400 mb-4">CONFIRM IDENTITY</h3>
            <p id="confirm-name-display" class="text-2xl font-bold text-white mb-6 p-2 bg-gray-800 border-l-4 border-blue-500 pl-4 break-all"></p>
            <div class="flex gap-4">
                <button onclick="closeConfirm()" class="flex-1 py-3 border border-gray-600 text-gray-400">CANCEL</button>
                <button id="btn-confirm-yes" class="flex-1 py-3 bg-blue-600 text-white font-bold">EXECUTE</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const PROTECTION_TIME_MS = 180000; // 3 min
        const AP_RECOVERY_MS = 5000; 
        const MAX_AP = 3;
        const HACK_COST = 2;

        const classMembers = [
            "Áî∞Â≥∂ Â§ßÊöâ", "Ê≤≥Áî∞ ÊÑõÂ≠ê", "Â±±‰∏≠ Â£±Á£ã", "ÈÅ†Ëó§ ÁµêË°£", "Â§ßË∞∑ ÂíåËºù", "‰∏≠Êùë È¢ØÂçó",
            "Â§ßÊõΩÊ†π Á∂≠Êúà", "Ëó§Êæ§ ÂøóÂ∏Ü", "ÂúíÈÉ® ÂèØÊÜê", "Áî∞ÂÆ∂ Áë∂Âß´", "Áå™Èáé Â§¢Â•à", "‰∏∏Â±± Êô¥Áîü",
            "Â±±Â¥é „Åó„Åä„Çì", "Â∞èÂ∂ã ÊùèÂ•à", "‰ΩêËó§ ÁíÉÈü≥", "Ê∏°ÈÇâ ÁæéÁ©∫", "‰ºöÁî∞ ÂøÉÁ©è", "Â∞æÂΩ¢ ÂãáÈ£õ",
            "Áõ∏Â†¥ Êó•ËèúË©©", "ÈΩãËó§ ÂÑ™", "Â∞èÂ∑ù Âø´Êô¥", "Ê∞¥Âè£ Â§èÊÇü", "‰Ωê„ÄÖÊú® ÁêâÊñó", "Â§ßÂ∑ù „ÇÅ„Çã",
            "Â≤°Áî∞ ÊÇ†Êñó", "ÂÆ§‰∫ï ÈôΩ‰∫∫", "Êµ∑ËÄÅÂéü Á©ÇÈ∑π", "ÂÜÖËó§ ÂÄñ‰∏ÄÊúó", "ËñÑ‰∫ï Èßø‰ªã", "Â∞èÊûó Êô∫ÂÆ•",
            "ÊúâÂπ¥ Á¶Ö", "È¶¨Â†¥ ÁæéÂπ∏", "Èà¥Êú® ÊùèÂ•à", "ÁßãËëâ ÂøÉÊÑõ"
        ].sort();

        let appState = {
            me: null,
            seats: Array(36).fill(null).map((_, i) => ({ id: i, owner: null, timestamp: 0 })),
            ap: MAX_AP
        };
        
        let pendingNameSelection = null;
        let pendingHackIndex = -1;
        
        // Hack Game State
        let hackState = {
            active: false,
            targetSeatIndex: -1,
            stage: 0,
            gameType: 'timing', // 'timing', 'rapid', 'memory'
            // Timing
            cursorPos: 0, direction: 1, speed: 1, targetStart: 0, targetWidth: 20,
            // Rapid
            rapidProgress: 0, rapidDecay: 0.5,
            // Memory
            sequence: [], playerInput: [], showingSeq: false,
            animId: null
        };

        window.onload = () => {
            const tl = anime.timeline({ easing: 'easeOutExpo', duration: 750 });
            tl.add({ targets: '#intro-sub', opacity: [0, 1], translateY: [20, 0] })
              .add({ targets: '#intro-title', opacity: [0, 1], scale: [3, 1], duration: 1000 })
              .add({ targets: '#intro-ver', opacity: [0, 1], delay: 200 })
              .add({ targets: '#start-btn', opacity: [0, 1], translateY: [20, 0], begin: () => document.getElementById('start-btn').classList.remove('hidden') });
            
            document.getElementById('start-btn').onclick = () => {
                showScreen('screen-char-select');
                renderCharSelect();
            };

            // Hack Action Button
            const hackBtn = document.getElementById('hack-btn');
            hackBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleHackAction(); });
            hackBtn.addEventListener('click', handleHackAction);
            
            // Hack Confirm Button
            document.getElementById('btn-hack-start').onclick = () => {
                if(pendingHackIndex !== -1) {
                    const idx = pendingHackIndex; 
                    closeHackConfirm();
                    startHackGame(idx);
                }
            };
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function renderCharSelect() {
            const grid = document.getElementById('char-grid');
            grid.innerHTML = '';
            classMembers.forEach(name => {
                const btn = document.createElement('button');
                btn.className = "p-2 md:p-4 border border-gray-700 bg-gray-900 hover:bg-purple-900 hover:border-purple-500 transition-all text-sm font-bold text-left group relative overflow-hidden flex items-center";
                btn.innerHTML = `<span class="relative z-10 truncate w-full block">${name}</span><div class="absolute inset-0 bg-purple-600 opacity-0 group-hover:opacity-20 transition-opacity"></div>`;
                btn.onclick = () => openConfirm(name);
                grid.appendChild(btn);
            });
        }

        window.openConfirm = function(name) {
            pendingNameSelection = name;
            document.getElementById('confirm-name-display').innerText = name;
            document.getElementById('modal-confirm').classList.remove('hidden');
            document.getElementById('modal-confirm').style.display = 'flex';
        }

        window.closeConfirm = function() {
            document.getElementById('modal-confirm').classList.add('hidden');
            document.getElementById('modal-confirm').style.display = 'none';
            pendingNameSelection = null;
        }

        document.getElementById('btn-confirm-yes').onclick = () => {
            if (pendingNameSelection) {
                window.joinGame(pendingNameSelection); // FIX: Ensure using global ref
                closeConfirm();
            }
        };

        window.joinGame = function(name) { // FIX: Make global
            appState.me = name;
            document.getElementById('my-name-display').innerText = name;
            showScreen('screen-battle');
            window.sendSystemLog(`${name} connected. v7 loaded.`);
            startApSystem();
            setInterval(() => { if(appState.seats) window.updateBattleField(appState.seats); }, 100);
        }

        function startApSystem() {
            updateApDisplay();
            setInterval(() => {
                if (appState.ap < MAX_AP && !hackState.active) {
                    appState.ap++;
                    updateApDisplay();
                }
            }, AP_RECOVERY_MS);
        }

        function updateApDisplay() {
            for (let i = 1; i <= MAX_AP; i++) {
                const el = document.getElementById(`ap-${i}`);
                if (i <= appState.ap) el.classList.add('active');
                else el.classList.remove('active');
            }
        }

        window.initializeFieldData = async function() {
            const initialSeats = Array(36).fill(null).map((_, i) => ({ 
                id: i, owner: null, uid: null, updatedAt: Date.now()
            }));
            await window.setDoc(window.doc(window.db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'public', 'data', 'seats_data', 'class_2-6_war_v7_multihack'), { seats: initialSeats });
        }

        window.updateBattleField = function(seatsData) {
            appState.seats = seatsData;
            const container = document.getElementById('seat-container');
            container.innerHTML = '';
            const now = Date.now();

            seatsData.forEach((seat, index) => {
                const isMine = seat.owner === appState.me;
                const isTaken = !!seat.owner;
                const elapsed = isTaken ? (now - seat.updatedAt) : 0;
                const isProtected = isTaken && elapsed < PROTECTION_TIME_MS;
                const remainingTime = Math.max(0, PROTECTION_TIME_MS - elapsed);
                const shieldPercent = (remainingTime / PROTECTION_TIME_MS) * 100;

                let cssClass = "seat-card flex flex-col items-center justify-center cursor-pointer rounded select-none relative ";
                if (isMine) cssClass += "seat-taken-me ";
                else if (isTaken) cssClass += isProtected ? "seat-shielded " : "seat-vulnerable ";
                else cssClass += "seat-empty hover:bg-gray-800 hover:border-white ";

                const el = document.createElement('div');
                el.className = cssClass;
                el.onclick = () => handleClickSeat(index, isProtected);

                if (isTaken) {
                    el.innerHTML = `
                        <div class="text-[10px] opacity-50 absolute top-1 left-1">ID:${index}</div>
                        ${isProtected ? '<div class="absolute top-1 right-1 text-green-400 text-[10px]">üõ°Ô∏èSHIELD</div>' : '<div class="absolute top-1 right-1 text-red-500 text-[10px] animate-pulse">‚ö†Ô∏èVULN</div>'}
                        <div class="font-bold text-xs md:text-sm text-center px-1 break-all leading-tight text-white drop-shadow-md z-10">
                            ${seat.owner.split(' ')[0]}
                        </div>
                        ${isProtected ? `<div class="shield-bar-container"><div class="shield-bar" style="width: ${shieldPercent}%"></div></div>` : ''}
                    `;
                } else {
                    el.innerHTML = `<div class="text-gray-500 font-tech text-xs">OPEN</div>`;
                }
                container.appendChild(el);
            });
        }

        window.handleClickSeat = function(index, isProtected) {
            if (!appState.me) return;
            const targetSeat = appState.seats[index];

            if (targetSeat.owner === appState.me) return;

            if (!targetSeat.owner || !isProtected) {
                if (appState.ap < 1) { flashAp(); return; }
                takeSeatNormal(index);
                return;
            }

            if (isProtected) {
                if (appState.ap < HACK_COST) { 
                    flashAp(); 
                    window.sendSystemLog(`[SYSTEM] Not enough AP to Hack. Need ${HACK_COST}.`);
                    return; 
                }
                openHackConfirm(index);
            }
        }

        window.openHackConfirm = function(index) {
            pendingHackIndex = index;
            const modal = document.getElementById('modal-hack-confirm');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        window.closeHackConfirm = function() {
            const modal = document.getElementById('modal-hack-confirm');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            pendingHackIndex = -1;
        }

        function flashAp() {
            anime({ targets: '.ap-container', scale: [1, 1.2, 1], opacity: [1, 0.5, 1], duration: 200, easing: 'easeInOutQuad' });
        }

        // --- MULTI-GAME LOGIC ---

        function startHackGame(index) {
            if (index < 0 || !appState.seats[index]) { console.error("Invalid hack index"); return; }
            hackState.active = true;
            hackState.targetSeatIndex = index;
            hackState.stage = 1;
            
            const games = ['timing', 'rapid', 'memory'];
            hackState.gameType = games[Math.floor(Math.random() * games.length)];
            
            document.getElementById('hack-ui').style.display = 'flex';
            
            document.getElementById('hack-stage-1').className = 'hack-dot active';
            document.getElementById('hack-stage-2').className = 'hack-dot';
            document.getElementById('hack-stage-3').className = 'hack-dot';

            initHackStage();
        }

        function initHackStage() {
            const gameArea = document.getElementById('hack-game-area');
            const hackBtn = document.getElementById('hack-btn');
            const title = document.getElementById('hack-title');
            const desc = document.getElementById('hack-desc');

            gameArea.innerHTML = '';
            hackBtn.style.display = 'block';
            hackBtn.textContent = 'EXECUTE';

            const diff = hackState.stage;

            switch (hackState.gameType) {
                case 'timing':
                    title.textContent = "TIMING HACK";
                    desc.textContent = "STOP THE CURSOR IN RED ZONE";
                    
                    hackState.targetWidth = 25 - (diff * 5); 
                    hackState.targetStart = Math.random() * (100 - hackState.targetWidth);
                    hackState.speed = 1 + (diff * 0.5);
                    hackState.cursorPos = 0;
                    hackState.direction = 1;
                    
                    gameArea.innerHTML = `
                        <div class="hack-bar-container">
                            <div id="hack-target" class="hack-target-zone" style="left:${hackState.targetStart}%; width:${hackState.targetWidth}%"></div>
                            <div id="hack-cursor" class="hack-cursor" style="left:0%"></div>
                        </div>
                    `;
                    break;

                case 'rapid':
                    title.textContent = "BRUTE FORCE";
                    desc.textContent = "MASH BUTTON TO FILL GAUGE";
                    hackBtn.textContent = "MASH!";
                    
                    hackState.rapidProgress = 0;
                    hackState.rapidDecay = 0.3 + (diff * 0.2);
                    
                    gameArea.innerHTML = `
                        <div class="rapid-gauge-container">
                            <div class="rapid-target-line"></div>
                            <div id="rapid-fill" class="rapid-gauge-fill"></div>
                        </div>
                    `;
                    break;

                case 'memory':
                    title.textContent = "PATTERN MATCH";
                    desc.textContent = "MEMORIZE AND REPEAT";
                    hackBtn.style.display = 'none'; 
                    
                    hackState.sequence = [];
                    hackState.playerInput = [];
                    const seqLen = 2 + diff; 
                    for(let i=0; i<seqLen; i++) hackState.sequence.push(Math.floor(Math.random()*4));
                    
                    gameArea.innerHTML = `
                        <div class="memory-grid">
                            <div id="mem-0" class="memory-btn" onclick="handleMemoryInput(0)"></div>
                            <div id="mem-1" class="memory-btn" onclick="handleMemoryInput(1)"></div>
                            <div id="mem-2" class="memory-btn" onclick="handleMemoryInput(2)"></div>
                            <div id="mem-3" class="memory-btn" onclick="handleMemoryInput(3)"></div>
                        </div>
                        <div id="mem-msg" class="text-xs text-yellow-400">WATCH...</div>
                    `;
                    
                    setTimeout(() => playMemorySequence(), 1000);
                    break;
            }

            if (hackState.animId) cancelAnimationFrame(hackState.animId);
            hackLoop();
        }

        function hackLoop() {
            if (!hackState.active) return;

            if (hackState.gameType === 'timing') {
                hackState.cursorPos += hackState.speed * hackState.direction;
                if (hackState.cursorPos >= 100) { hackState.cursorPos = 100; hackState.direction = -1; }
                else if (hackState.cursorPos <= 0) { hackState.cursorPos = 0; hackState.direction = 1; }
                const cursor = document.getElementById('hack-cursor');
                if(cursor) cursor.style.left = hackState.cursorPos + '%';
            }
            else if (hackState.gameType === 'rapid') {
                hackState.rapidProgress -= hackState.rapidDecay;
                if (hackState.rapidProgress < 0) hackState.rapidProgress = 0;
                const fill = document.getElementById('rapid-fill');
                if(fill) fill.style.height = hackState.rapidProgress + '%';
            }

            hackState.animId = requestAnimationFrame(hackLoop);
        }

        window.handleHackAction = function() {
            if (!hackState.active) return;
            
            if (hackState.gameType === 'timing') {
                const hit = hackState.cursorPos >= hackState.targetStart && 
                            hackState.cursorPos <= (hackState.targetStart + hackState.targetWidth);
                if (hit) nextStage();
                else failHack();
            }
            else if (hackState.gameType === 'rapid') {
                hackState.rapidProgress += 10;
                if (hackState.rapidProgress >= 100) nextStage();
            }
        }

        async function playMemorySequence() {
            hackState.showingSeq = true;
            const msg = document.getElementById('mem-msg');
            if(msg) msg.textContent = "WATCH...";
            
            for (let i = 0; i < hackState.sequence.length; i++) {
                await new Promise(r => setTimeout(r, 500));
                const btnId = hackState.sequence[i];
                const btn = document.getElementById(`mem-${btnId}`);
                if(btn) {
                    btn.classList.add('flash');
                    await new Promise(r => setTimeout(r, 300));
                    btn.classList.remove('flash');
                }
            }
            
            hackState.showingSeq = false;
            if(msg) {
                msg.textContent = "REPEAT!";
                msg.classList.replace('text-yellow-400', 'text-green-400');
            }
        }

        window.handleMemoryInput = function(id) {
            if (!hackState.active || hackState.showingSeq) return;
            
            const btn = document.getElementById(`mem-${id}`);
            btn.classList.add('flash');
            setTimeout(() => btn.classList.remove('flash'), 200);

            const currentStep = hackState.playerInput.length;
            if (id === hackState.sequence[currentStep]) {
                hackState.playerInput.push(id);
                if (hackState.playerInput.length === hackState.sequence.length) {
                    setTimeout(() => nextStage(), 500);
                }
            } else {
                failHack();
            }
        }

        function nextStage() {
            if (hackState.stage >= 3) {
                endHack(true);
            } else {
                document.getElementById(`hack-stage-${hackState.stage}`).className = 'hack-dot done';
                hackState.stage++;
                document.getElementById(`hack-stage-${hackState.stage}`).className = 'hack-dot active';
                initHackStage();
            }
        }

        function failHack() {
            endHack(false);
        }

        function endHack(success) {
            hackState.active = false;
            cancelAnimationFrame(hackState.animId);
            document.getElementById('hack-ui').style.display = 'none';

            appState.ap -= HACK_COST;
            updateApDisplay();

            if (success) {
                takeSeatForce(hackState.targetSeatIndex);
                anime({ targets: '#screen-battle', filter: ['hue-rotate(0deg)', 'hue-rotate(90deg)', 'hue-rotate(0deg)'], duration: 500 });
            } else {
                anime({ targets: '#screen-battle', translateX: [0, -10, 10, 0], duration: 400 });
                window.sendSystemLog(`[FAIL] ${appState.me} failed hacking seat ${hackState.targetSeatIndex}.`);
            }
        }

        async function takeSeatNormal(index) {
            appState.ap -= 1;
            updateApDisplay();
            await executeSeatUpdate(index, false);
        }

        async function takeSeatForce(index) {
            await executeSeatUpdate(index, true);
        }

        async function executeSeatUpdate(index, isHack) {
            if (navigator.vibrate) navigator.vibrate(50);

            // FIX: Robust check to prevent undefined access
            const newSeats = [...appState.seats];
            if (!newSeats[index]) { 
                console.error("Critical Error: Seat index out of bounds or data not loaded", index); 
                return; 
            }
            
            const myUid = window.auth.currentUser ? window.auth.currentUser.uid : "anon";
            const targetSeat = newSeats[index];
            const prevOwner = targetSeat.owner;
            const now = Date.now();
            
            newSeats.forEach(s => {
                if (s.owner === appState.me) { s.owner = null; s.uid = null; }
            });

            newSeats[index] = { id: index, owner: appState.me, uid: myUid, updatedAt: now };

            try {
                // Fix: Use global appId for DB path
                const currentAppId = window.appId || (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
                const docRef = window.doc(window.db, 'artifacts', currentAppId, 'public', 'data', 'seats_data', window.BATTLE_DOC_ID);
                await window.setDoc(docRef, { seats: newSeats });
                
                if (isHack) window.sendSystemLog(`[HACKED] ${appState.me} BYPASSED FIREWALL and seized seat ${index} from ${prevOwner}!`);
                else if (prevOwner) window.sendSystemLog(`[TAKEOVER] ${appState.me} seized seat ${index}.`);
                else window.sendSystemLog(`[SECURE] ${appState.me} secured seat ${index}.`);

            } catch (e) { 
                console.error("Update Failed", e); 
                window.updateConnectionStatus(false);
            }
        }

        // --- CHAT ---
        window.switchTab = function(tab) {
            document.getElementById('panel-log').classList.toggle('hidden', tab !== 'log');
            document.getElementById('panel-chat').classList.toggle('hidden', tab !== 'chat');
            document.getElementById('tab-log').className = tab === 'log' ? "flex-1 py-2 text-xs font-bold text-center bg-gray-900 text-green-400 border-b-2 border-green-400" : "flex-1 py-2 text-xs font-bold text-center bg-gray-800 text-gray-400";
            document.getElementById('tab-chat').className = tab === 'chat' ? "flex-1 py-2 text-xs font-bold text-center bg-gray-900 text-blue-400 border-b-2 border-blue-400" : "flex-1 py-2 text-xs font-bold text-center bg-gray-800 text-gray-400";
        }

        window.sendChat = async function() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !appState.me) return;
            
            const currentAppId = window.appId || (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
            const colRef = window.collection(window.db, 'artifacts', currentAppId, 'public', 'data', 'seat_battle_chats');
            await window.addDoc(colRef, {
                name: appState.me, text: text, type: 'chat', timestamp: window.serverTimestamp()
            });
            input.value = '';
        }

        window.sendSystemLog = async function(text) { // FIX: Attach to window & use global appId
            const currentAppId = window.appId || (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');
            const colRef = window.collection(window.db, 'artifacts', currentAppId, 'public', 'data', 'seat_battle_chats');
            await window.addDoc(colRef, {
                name: "SYSTEM", text: text, type: 'log', timestamp: window.serverTimestamp()
            });
        }

        window.updateChatLog = function(chats) {
            const chatBox = document.getElementById('chat-messages');
            const logBox = document.getElementById('log-messages');
            chatBox.innerHTML = ''; logBox.innerHTML = '';
            chats.reverse().forEach(c => {
                if (c.type === 'log') {
                    const l = document.createElement('div'); l.innerHTML = `> ${c.text}`; logBox.appendChild(l);
                } else {
                    const div = document.createElement('div');
                    const isMe = c.name === appState.me;
                    div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
                    div.innerHTML = `<div class="text-[10px] text-gray-500 mb-0.5">${c.name}</div><div class="${isMe ? 'bg-purple-900 border-purple-500' : 'bg-gray-800 border-gray-600'} border px-3 py-1.5 rounded text-xs max-w-[85%] break-words">${c.text}</div>`;
                    chatBox.appendChild(div);
                }
            });
            chatBox.scrollTop = chatBox.scrollHeight; logBox.scrollTop = logBox.scrollHeight;
        }

        window.toggleRules = function() {
            const m = document.getElementById('modal-rules');
            if (m.classList.contains('hidden')) { m.classList.remove('hidden'); m.style.display = 'flex'; }
            else { m.classList.add('hidden'); m.style.display = 'none'; }
        }
    </script>
</body>
</html>
