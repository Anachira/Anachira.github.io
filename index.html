<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>88-WORKS | SEAT MANAGER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- SoundCloud Widget API -->
    <script src="https://w.soundcloud.com/player/api.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        let appId;
        let isCanvasEnv = false;

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                isCanvasEnv = true;
            } else {
                firebaseConfig = {
                  apiKey: "AIzaSyB1INAQOnhKBW02En-FHNecXoJUNT-cAfU",
                  authDomain: "seatarrange.firebaseapp.com",
                  projectId: "seatarrange",
                  storageBucket: "seatarrange.firebasestorage.app",
                  messagingSenderId: "862438952644",
                  appId: "1:862438952644:web:86f41796b44f304da0c391",
                  measurementId: "G-CHMPH017HT"
                };
                appId = 'seat-shuffle-prod'; 
            }

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            window.db = db;
            window.auth = auth;
            window.doc = doc;
            window.setDoc = setDoc;
            window.appId = appId;
            window.isCanvasEnv = isCanvasEnv;

            const initAuth = async () => {
                try {
                    updateStatus("AUTHENTICATING...", "yellow");
                    if (isCanvasEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth failed", error);
                    updateStatus(`ERROR: ${error.code}`, "red");
                }
            };

            initAuth();

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User authenticated:", user.uid);
                    setupRealtimeListener();
                }
            });

            function setupRealtimeListener() {
                if (!auth.currentUser) return;
                
                let seatsDocRef;
                if (window.isCanvasEnv) {
                    seatsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'seats', 'current_layout');
                } else {
                    seatsDocRef = doc(db, 'seats_data', 'class_2-6');
                }

                onSnapshot(seatsDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.seats) {
                            window.updateSeatsFromCloud(data.seats);
                            updateStatus("SYSTEM ONLINE", "green");
                        }
                    } else {
                        updateStatus("INITIALIZING DB...", "yellow");
                        window.initializeCloudData();
                    }
                }, (error) => {
                    console.error("Sync error", error);
                    updateStatus(`SYNC ERROR: ${error.code}`, "red");
                });
            }

        } catch (e) {
            console.error("Initialization error", e);
            updateStatus("INIT ERROR", "red");
        }

        function updateStatus(text, color) {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                statusEl.innerText = text;
                statusEl.className = `text-xs font-mono text-${color}-500 font-bold`;
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@700;900&display=swap');
        
        :root {
            --bg-color: #050505;
            --main-color: #00ff41; 
            --text-glow: #a8ffb6;
            --dim-color: #008f11;
            --alert-color: #ff3333;
        }

        body {
            font-family: 'Share Tech Mono', 'Noto Sans JP', monospace;
            background-color: var(--bg-color);
            color: var(--main-color);
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            min-height: 100vh;
            text-transform: uppercase;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; 
        }

        /* ライセンス画面スタイル */
        #license-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: turnOn 0.5s ease-out forwards;
        }

        @keyframes turnOn {
            0% { transform: scale(1, 0.002); opacity: 0; filter: brightness(30); }
            50% { transform: scale(1, 0.002); opacity: 1; }
            75% { transform: scale(1.1, 1); opacity: 1; }
            100% { transform: scale(1, 1); opacity: 1; filter: brightness(1); }
        }

        .license-box {
            max-width: 800px;
            width: 100%;
            border: 2px solid var(--main-color);
            padding: 30px;
            background: rgba(0, 10, 0, 0.95);
            box-shadow: 0 0 20px var(--dim-color);
            position: relative;
        }

        .license-box.alert-mode {
            border-color: var(--alert-color);
            box-shadow: 0 0 30px var(--alert-color);
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .license-text-line {
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 5px;
            opacity: 1;
            color: #00ff41 !important;
            text-shadow: 0 0 8px rgba(0, 255, 65, 0.6);
            font-weight: bold;
        }

        .text-green { color: #00ff41 !important; text-shadow: 0 0 8px rgba(0, 255, 65, 0.6); }
        .text-red { color: #ff3333 !important; text-shadow: 0 0 10px rgba(255, 0, 0, 0.8); }
        .text-black-weight { font-weight: 900 !important; } 
        
        .typing-cursor::after {
            content: '█';
            animation: blink 0.8s step-end infinite;
            color: var(--main-color);
            margin-left: 5px;
        }

        .glitch-text {
            animation: glitch 1s infinite linear alternate-reverse;
        }
        @keyframes glitch {
            0% { transform: skew(0deg); opacity: 1; }
            20% { transform: skew(-2deg); opacity: 0.8; }
            40% { transform: skew(2deg); opacity: 1; }
            60% { transform: skew(0deg); opacity: 0.9; }
            80% { transform: skew(5deg); opacity: 1; }
            100% { transform: skew(0deg); opacity: 1; }
        }

        .access-granted {
            animation: accessGranted 1s forwards;
        }
        @keyframes accessGranted {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); filter: brightness(2); background-color: var(--main-color); color: #000; }
            100% { opacity: 0; transform: scale(1.5); display: none; }
        }

        .access-denied {
            border-color: var(--alert-color) !important;
            color: var(--alert-color) !important;
            box-shadow: 0 0 30px var(--alert-color) !important;
        }

        #main-app {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            padding: 20px 0;
            opacity: 0;
            transition: opacity 1s;
        }

        .brand-text { text-shadow: 0 0 10px var(--main-color); }
        
        .user-badge {
            border: 1px solid var(--main-color);
            padding: 2px 8px;
            background: rgba(0, 255, 65, 0.1);
            font-size: 0.7rem;
            letter-spacing: 1px;
        }

        footer {
            margin-top: auto;
            width: 100%;
            max-width: 1024px;
            border-top: 1px solid var(--dim-color);
            padding: 40px 0;
            font-size: 0.75rem;
            opacity: 0.9;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
            text-align: center;
        }
        
        @media (min-width: 640px) {
            .profile-section {
                flex-direction: row;
                justify-content: space-between;
                text-align: left;
                padding: 0 20px;
            }
        }

        /* Tenor GIF用コンテナスタイル (修正版) */
        .profile-container {
            width: 150px;
            height: 150px; /* 正方形に固定 */
            border: 1px solid var(--main-color);
            box-shadow: 0 0 15px var(--dim-color);
            transition: all 0.3s;
            border-radius: 0.5rem;
            overflow: hidden; /* はみ出しをカット */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }
        .profile-container:hover {
            box-shadow: 0 0 20px var(--main-color);
            transform: scale(1.05);
        }

        .terminal-box {
            border: 1px solid var(--main-color);
            background-color: rgba(0, 20, 0, 0.85);
            box-shadow: 0 0 15px var(--dim-color);
            position: relative;
        }
        
        .terminal-box::before {
            content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px;
            border-top: 2px solid var(--main-color); border-left: 2px solid var(--main-color);
        }
        .terminal-box::after {
            content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px;
            border-bottom: 2px solid var(--main-color); border-right: 2px solid var(--main-color);
        }

        .seat {
            aspect-ratio: 4/3;
            cursor: pointer;
            border: 1px solid var(--dim-color);
            background: rgba(0, 10, 0, 0.7);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seat:hover {
            border-color: var(--main-color);
            box-shadow: inset 0 0 20px var(--dim-color);
            background: rgba(0, 40, 0, 0.9);
            z-index: 10;
        }

        .seat.dragging {
            opacity: 0.5;
            border: 2px dashed var(--main-color);
        }

        .seat-content {
            pointer-events: none;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.3;
            letter-spacing: 0.05em;
            color: #ffffff;
            text-shadow: 0 0 5px var(--main-color), 0 0 10px var(--dim-color);
            width: 100%;
            word-break: break-all;
        }

        .locked {
            border-color: var(--alert-color) !important;
            box-shadow: inset 0 0 10px rgba(100, 0, 0, 0.5);
        }
        .locked .seat-content {
            text-shadow: 0 0 5px var(--alert-color);
            color: #ffebeb;
        }
        .locked::after {
            content: '[LOCKED]';
            position: absolute;
            top: 2px; right: 2px;
            font-size: 0.6rem;
            color: var(--alert-color);
            font-family: 'Share Tech Mono', monospace;
            opacity: 0.8;
        }

        .btn-cli {
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid var(--main-color);
            color: var(--main-color);
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s;
        }
        .btn-cli:hover {
            background: var(--main-color);
            color: #000;
            box-shadow: 0 0 15px var(--main-color);
            font-weight: bold;
        }

        .blackboard {
            border: 1px solid var(--dim-color);
            color: var(--dim-color);
            font-size: 0.9rem;
            font-weight: bold;
            text-align: center;
            background: repeating-linear-gradient(45deg, rgba(0,0,0,0.8), rgba(0,0,0,0.8) 10px, rgba(0,30,0,0.8) 10px, rgba(0,30,0,0.8) 20px);
            text-shadow: 0 0 3px var(--dim-color);
        }

        .modal-bg {
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid var(--main-color);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
        }
        
        input[type="text"] {
            background: #000;
            border: 1px solid var(--dim-color);
            color: var(--main-color);
            font-family: 'Noto Sans JP', monospace;
            font-weight: bold;
            font-size: 1.1rem;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 15px var(--dim-color);
        }

        .blinking-cursor::after {
            content: '_';
            animation: blink 1s step-end infinite;
            margin-left: 5px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        @media print {
            body { background: white; color: black; background-image: none; }
            .seat { border: 2px solid #000; color: #000; background: white; }
            .seat-content { color: #000; text-shadow: none; font-weight: bold; }
            .terminal-box { border: 2px solid #000; box-shadow: none; background: white; }
            .no-print { display: none; }
            .locked::after { color: #000; }
            footer { display: none; }
            #license-overlay { display: none; }
            #main-app { display: flex !important; opacity: 1 !important; }
        }
    </style>
</head>
<body>

    <!-- ライセンス画面 (オーバーレイ) -->
    <div id="license-overlay">
        <div class="license-box">
            <h2 class="text-xl font-bold mb-4 border-b border-green-700 pb-2 text-green-400">>> SYSTEM_BOOT: 88-WORKS_KERNEL</h2>
            <div id="license-text-container" class="font-mono"></div>
            
            <div id="license-buttons" class="flex justify-between mt-8 opacity-0 transition-opacity duration-500">
                <button onclick="declineLicense()" class="btn-cli px-6 py-2 text-red-500 border-red-500 hover:bg-red-900 hover:text-white">
                    [ N ] DECLINE
                </button>
                <button onclick="acceptLicense()" class="btn-cli px-6 py-2 text-green-400 font-bold hover:bg-green-900 hover:text-white">
                    [ Y ] ACCEPT
                </button>
            </div>
        </div>
    </div>

    <!-- メインアプリ (初期は非表示) -->
    <div id="main-app" style="display: none;">
        <!-- ヘッダー -->
        <header class="w-full max-w-5xl mb-6 flex flex-col sm:flex-row justify-between items-end terminal-box p-6 no-print gap-4">
            <div>
                <h1 class="text-2xl sm:text-4xl font-bold tracking-widest blinking-cursor brand-text">
                    SYSTEM: 88-WORKS SEAT MANAGER
                </h1>
                <p class="text-xs sm:text-sm opacity-80 mt-2 font-mono text-green-400">
                    > ADMIN: <span class="user-badge">ROOT OVERCLOCKER</span><br>
                    > BUILD: 88-WORKS_CORE_V2022<br>
                    > STATUS: <span id="connection-status" class="text-yellow-500">CONNECTING...</span>
                </p>
            </div>
            <div class="flex flex-wrap gap-3 justify-end">
                <button onclick="shuffleSeats()" class="btn-cli px-6 py-3 flex items-center gap-2 font-bold">
                    [ AUTO_SHUFFLE ]
                </button>
                <button onclick="downloadImage()" class="btn-cli px-6 py-3 flex items-center gap-2 font-bold">
                    [ EXPORT_IMAGE ]
                </button>
            </div>
        </header>

        <!-- メインエリア -->
        <main id="classroom-area" class="w-full max-w-5xl terminal-box p-4 sm:p-8 relative">
            <div class="absolute top-3 left-4 text-[0.7rem] text-green-600 font-mono hidden sm:block leading-tight">
                > DEPLOYED_BY: 88-WORKS<br>
                > PROJECT_START: 2022<br>
                > LATENCY: <span id="latency-val">--</span>ms
            </div>

            <div id="seat-grid" class="grid grid-cols-6 gap-3 sm:gap-5 mb-8 mt-10 relative z-10">
                <!-- JSで生成 -->
            </div>

            <div class="w-full flex justify-center mb-2 mt-6 relative z-10">
                <div class="blackboard w-2/3 h-16 flex items-center justify-center tracking-widest">
                    [ FRONT_AREA / WHITEBOARD ]
                </div>
            </div>

            <div class="flex justify-between items-end mt-6 border-t border-green-900 pt-3">
                <div class="text-xs text-green-600 font-mono">
                    SECURE_CONNECTION: ENCRYPTED_BY_88WORKS
                </div>
                <div class="text-right text-xs sm:text-sm opacity-70 font-mono">
                    LAST_UPDATE: <span id="current-date"></span>
                </div>
            </div>
        </main>

        <!-- フッター: プロフィール & BGM -->
        <footer class="no-print">
            
            <div class="profile-section w-full max-w-5xl terminal-box p-6 mb-4">
                <div class="flex flex-col sm:flex-row items-center gap-6 w-full">
                    <!-- GIF Icon (Tenor Embed) - Cropped to Square -->
                    <div class="shrink-0 profile-container">
                        <!-- Imouto Sae Ireba Ii GIF (Updated via iframe for better control/sizing) -->
                        <iframe src="https://giphy.com/embed/GT46Efqk6oPBsGeRK7" width="100%" height="100%" style="pointer-events: none;" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
                    </div>
                    
                    <!-- Info -->
                    <div class="font-mono text-sm sm:text-base flex-grow w-full">
                        <div class="border-b border-green-800 pb-2 mb-2 text-green-400 font-bold">
                            >> DEVELOPER_PROFILE
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <div>
                                <span class="text-green-600">> NAME:</span> ISSA YAMANAKA<br>
                                <span class="text-green-600">> ROLE:</span> ROOT OVERCLOCKER<br>
                                <span class="text-green-600">> OS:</span> ARCH LINUX (BTW)
                            </div>
                            <div>
                                <span class="text-green-600">> GITHUB:</span> <a href="https://github.com/Anachira" target="_blank" class="hover:text-white underline">Anachira</a><br>
                                <span class="text-green-600">> DISCORD:</span> hachiya_works<br>
                                <span class="text-green-600">> EMAIL:</span> <a href="mailto:luruna_anachira.88works@outlook.com" class="hover:text-white underline">luruna...</a>
                            </div>
                        </div>
                        <div class="mt-4 text-xs text-green-700">
                            /* 88-WORKS PROJECT EST. 2022 */
                        </div>
                    </div>
                </div>
            </div>

            <!-- BGM Player (Embedded in Footer) -->
            <div class="w-full max-w-5xl terminal-box p-2">
                <div class="text-[0.6rem] text-green-800 font-mono mb-1 pl-2">> BACKGROUND_AUDIO_STREAM</div>
                <iframe id="sc-widget" width="100%" height="100" scrolling="no" frameborder="no" allow="autoplay" 
                    src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/tartrate/fire-the-daybreak&color=%2300ff41&auto_play=false&hide_related=false&show_comments=false&show_user=true&show_reposts=false&show_teaser=true&visual=false">
                </iframe>
            </div>

        </footer>
    </div>

    <!-- 編集モーダル -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="modal-bg p-8 w-96 shadow-2xl relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-green-500 box-shadow-glow"></div>
            <h3 class="text-xl font-bold mb-6 flex items-center gap-2 border-b border-green-900 pb-3 text-white" style="text-shadow: 0 0 8px var(--main-color);">
                >> EDIT_STUDENT_DATA
            </h3>
            <div class="mb-8">
                <label class="block text-xs font-bold mb-2 text-green-400 font-mono">TARGET_NAME_INPUT:</label>
                <input type="text" id="edit-name-input" class="w-full px-4 py-3 text-lg">
            </div>
            <div class="flex items-center mb-10 cursor-pointer p-2 border border-transparent hover:border-green-900 transition" onclick="document.getElementById('edit-lock-check').click()">
                <input type="checkbox" id="edit-lock-check" class="h-5 w-5 bg-black border-green-500 rounded-none accent-green-500 cursor-pointer">
                <label for="edit-lock-check" class="ml-4 block text-sm font-bold cursor-pointer select-none text-white">
                    ENABLE_POSITION_LOCK
                </label>
            </div>
            <div class="flex justify-end gap-4">
                <button onclick="closeModal()" class="px-6 py-2 text-sm border border-gray-700 text-gray-400 hover:border-gray-500 hover:text-white transition font-mono">CANCEL</button>
                <button onclick="saveEdit()" class="btn-cli px-8 py-3 text-sm bg-green-900 bg-opacity-30 font-bold">SAVE_DATA</button>
            </div>
        </div>
    </div>

    <script>
        // --- SoundCloud Loop Script ---
        const iframeElement = document.getElementById('sc-widget');
        const widget = SC.Widget(iframeElement);
        
        widget.bind(SC.Widget.Events.FINISH, function() {
            widget.seekTo(0);
            widget.play();
        });

        // --- ライセンス画面の処理 ---
        const licenseData = [
            { text: "WARNING: UNAUTHORIZED ACCESS IS STRICTLY PROHIBITED.", style: "text-green" },
            { text: "DETECTING USER PRIVILEGES...", style: "text-green" },
            { text: "ACCESS GRANTED: GUEST LEVEL 1", style: "text-green" },
            { text: "", style: "" },
            // ここにプレーヤーが重なるため空白行を設ける
            { text: "", style: "" },
            { text: "", style: "" }, 
            { text: "", style: "" },
            { text: "LICENSE AGREEMENT:", style: "text-green" },
            { text: "1. ALL DATA TRANSMISSIONS ARE ENCRYPTED.", style: "text-green" },
            { text: "2. DO NOT SHARE ACCESS KEYS.", style: "text-green" },
            { text: "3. ALL ACTIONS ARE LOGGED BY ROOT OVERCLOCKER.", style: "text-green" },
            { text: "4. OBEY THE ADMIN AT ALL TIMES.", style: "text-green" },
            { text: "", style: "" },
            // 警告文
            { text: "WARNING: SECURITY ALERT", style: "text-red text-xl font-bold glitch-text" },
            { text: "----------------------------------------", style: "text-red" },
            { text: "本システムに対する不正アクセス及び妨害行為（荒らし）が検知された場合、", style: "text-red" },
            { text: "管理者 山中壱磋 (ROOT OVERCLOCKER) により", style: "text-red text-lg text-black-weight" }, // 極太フォントクラス適用
            { text: "直ちに報復プロトコル \"JUDGEMENT_DAY\" を実行する。", style: "text-red" },
            { text: "対象IPに対してDDoS攻撃を展開し、", style: "text-red text-lg" },
            { text: "デバイス内の全データを強制暗号化（ロック）する。", style: "text-red text-lg" },
            { text: "命が惜しければ、ルールを遵守せよ。", style: "text-red text-xl glitch-text" },
            { text: "----------------------------------------", style: "text-red" },
            { text: "", style: "" },
            { text: "DO YOU ACCEPT THESE TERMS?", style: "text-green" }
        ];

        async function typeWriter(data, elementId, speed = 5) {
            const container = document.getElementById(elementId);
            container.innerHTML = ""; 
            
            for (let i = 0; i < data.length; i++) {
                const lineData = data[i];
                const lineDiv = document.createElement('div');
                lineDiv.className = `license-text-line typing-cursor ${lineData.style}`; 
                container.appendChild(lineDiv);
                
                if (lineData.style.includes('text-red')) {
                    document.querySelector('.license-box').classList.add('alert-mode');
                } else {
                    document.querySelector('.license-box').classList.remove('alert-mode');
                }

                const lineText = lineData.text;
                // 空行の場合はスキップ
                if (lineText.length === 0) {
                    lineDiv.innerHTML = "&nbsp;"; 
                    lineDiv.classList.remove('typing-cursor');
                    continue;
                }

                for (let j = 0; j < lineText.length; j++) {
                    lineDiv.textContent = lineText.substring(0, j + 1);
                    const currentSpeed = lineData.style.includes('text-red') ? 20 : speed;
                    await new Promise(r => setTimeout(r, currentSpeed));
                }
                
                lineDiv.classList.remove('typing-cursor');
                await new Promise(r => setTimeout(r, 20)); 
            }
            
            const lastLine = container.lastElementChild;
            if (lastLine) lastLine.classList.add('typing-cursor');
            
            document.getElementById('license-buttons').style.opacity = '1';
        }

        function acceptLicense() {
            const overlay = document.getElementById('license-overlay');
            const box = overlay.querySelector('.license-box');
            
            box.classList.add('access-granted');
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    const mainApp = document.getElementById('main-app');
                    mainApp.style.display = 'flex';
                    setTimeout(() => mainApp.style.opacity = '1', 50);
                    document.body.style.overflow = 'auto'; 
                }, 500);
            }, 800);
        }

        function declineLicense() {
            const box = document.querySelector('.license-box');
            box.classList.add('access-denied');
            
            const textContainer = document.getElementById('license-text-container');
            textContainer.innerHTML = `
                <div class="text-red-500 font-bold text-xl mt-10 text-center glitch-text">
                    ACCESS DENIED<br>
                    CONNECTION TERMINATED BY HOST<br>
                    <br>
                    > SYSTEM HALTED.
                </div>
            `;
            document.getElementById('license-buttons').style.display = 'none';
        }

        window.addEventListener('load', () => {
            typeWriter(licenseData, 'license-text-container', 5);
        });


        // --- 以下、既存のアプリロジック ---

        const initialSeatsData = [
            ["田島 大暉", "河田 愛子", "山中 壱磋", "遠藤 結衣", "大谷 和輝", "中村 颯南"],
            ["大曽根 維月", "藤澤 志帆", "園部 可憐", "田家 瑶姫", "猪野 夢奈", "丸山 晴生"],
            ["山崎 しおん", "小嶋 杏奈", "佐藤 璃音", "渡邉 美空", "会田 心穏", "尾形 勇飛"],
            ["相場 日菜詩", "齋藤 優", "小川 快晴", "水口 夏悟", "佐々木 琉斗", "大川 める"],
            ["岡田 悠斗", "室井 陽人", "海老原 穂鷹", "内藤 倖一朗", "薄井 駿介", "小林 智宥"],
            ["", "有年 禅", "馬場 美幸", "鈴木 杏奈", "秋葉 心愛", ""]
        ];

        let seats = []; 
        let draggingSeatIndex = null;
        let editingSeatIndex = null;

        // --- Cloud Sync Functions ---
        window.initializeCloudData = async function() {
            if (!window.auth.currentUser) return;
            console.log("Initializing Cloud Data...");
            seats = [];
            let index = 0;
            for (let r = 0; r < 6; r++) {
                for (let c = 0; c < 6; c++) {
                    const name = initialSeatsData[r][c];
                    seats.push({
                        id: index,
                        name: name,
                        locked: false
                    });
                    index++;
                }
            }
            await uploadSeatsToCloud(seats);
        }

        window.updateSeatsFromCloud = function(cloudSeats) {
            seats = cloudSeats;
            renderSeats();
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 19).replace('T', ' ');
            document.getElementById('current-date').textContent = dateStr;
            document.getElementById('latency-val').textContent = Math.floor(Math.random() * 20 + 10);
        }

        async function uploadSeatsToCloud(newSeats) {
            if (!window.db || !window.appId || !window.auth.currentUser) return;
            try {
                let docRef;
                if (window.isCanvasEnv) {
                    docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'seats', 'current_layout');
                } else {
                    docRef = window.doc(window.db, 'seats_data', 'class_2-6');
                }
                await window.setDoc(docRef, {
                    seats: newSeats,
                    lastUpdated: new Date().toISOString()
                });
            } catch (e) {
                console.error("Upload failed", e);
                alert("SYNC_ERROR: DATA_UPLOAD_FAILED");
            }
        }

        function renderSeats() {
            const grid = document.getElementById('seat-grid');
            grid.innerHTML = '';
            seats.forEach((seat, index) => {
                const el = document.createElement('div');
                let classes = `seat flex flex-col items-center justify-center text-center p-1 relative`;
                if (seat.locked) classes += ' locked';
                if (!seat.name) classes += ' opacity-40'; 
                el.className = classes;
                el.draggable = true;
                el.dataset.index = index;
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('touchstart', handleTouchStart, {passive: false});
                el.addEventListener('touchmove', handleTouchMove, {passive: false});
                el.addEventListener('touchend', handleTouchEnd);
                el.addEventListener('click', () => openModal(index));
                
                const idxLabel = document.createElement('div');
                idxLabel.className = 'absolute top-1 left-1 text-[0.6rem] text-green-800 font-mono pointer-events-none';
                idxLabel.innerText = `${String(index).padStart(2, '0')}`;
                el.appendChild(idxLabel);

                const content = document.createElement('div');
                content.className = 'seat-content w-full break-words z-10';
                if (seat.name) {
                    content.innerHTML = seat.name.replace(' ', '<br>');
                } else {
                    content.innerHTML = '<span class="text-[0.8rem] opacity-30 font-mono">[ NULL ]</span>';
                }
                el.appendChild(content);
                grid.appendChild(el);
            });
        }

        function handleDragStart(e) {
            draggingSeatIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        function handleDrop(e) {
            e.stopPropagation();
            const targetIndex = parseInt(this.dataset.index);
            if (draggingSeatIndex !== null && draggingSeatIndex !== targetIndex) {
                swapSeats(draggingSeatIndex, targetIndex);
            }
            return false;
        }
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggingSeatIndex = null;
        }

        let touchDragSrc = null;
        function handleTouchStart(e) {
            touchDragSrc = this;
            this.classList.add('dragging');
        }
        function handleTouchMove(e) { e.preventDefault(); }
        function handleTouchEnd(e) {
            this.classList.remove('dragging');
            const touch = e.changedTouches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetSeat = target ? target.closest('.seat') : null;
            if (targetSeat && touchDragSrc && targetSeat !== touchDragSrc) {
                const srcIndex = parseInt(touchDragSrc.dataset.index);
                const targetIndex = parseInt(targetSeat.dataset.index);
                swapSeats(srcIndex, targetIndex);
            }
            touchDragSrc = null;
        }

        async function swapSeats(idx1, idx2) {
            const newSeats = JSON.parse(JSON.stringify(seats));
            const tempName = newSeats[idx1].name;
            const tempLock = newSeats[idx1].locked;
            newSeats[idx1].name = newSeats[idx2].name;
            newSeats[idx1].locked = newSeats[idx2].locked;
            newSeats[idx2].name = tempName;
            newSeats[idx2].locked = tempLock;
            await uploadSeatsToCloud(newSeats);
        }

        function openModal(index) {
            editingSeatIndex = index;
            const seat = seats[index];
            document.getElementById('edit-name-input').value = seat.name;
            document.getElementById('edit-lock-check').checked = seat.locked;
            const modal = document.getElementById('edit-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('edit-name-input').focus();
        }
        function closeModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingSeatIndex = null;
        }
        async function saveEdit() {
            if (editingSeatIndex !== null) {
                const newName = document.getElementById('edit-name-input').value;
                const isLocked = document.getElementById('edit-lock-check').checked;
                const newSeats = JSON.parse(JSON.stringify(seats));
                newSeats[editingSeatIndex].name = newName;
                newSeats[editingSeatIndex].locked = isLocked;
                await uploadSeatsToCloud(newSeats);
                closeModal();
            }
        }

        async function shuffleSeats() {
            if (!confirm('WARNING: EXECUTE RANDOM SHUFFLE SEQUENCE?\n(Locked seats will remain unchanged)')) return;
            const newSeats = JSON.parse(JSON.stringify(seats));
            let movableStudents = [];
            let availableIndices = [];
            newSeats.forEach((seat, index) => {
                if (!seat.locked) {
                    availableIndices.push(index);
                    movableStudents.push(seat.name);
                }
            });
            for (let i = movableStudents.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [movableStudents[i], movableStudents[j]] = [movableStudents[j], movableStudents[i]];
            }
            availableIndices.forEach((seatIndex, i) => {
                newSeats[seatIndex].name = movableStudents[i];
            });
            await uploadSeatsToCloud(newSeats);
        }

        function downloadImage() {
            const element = document.getElementById('classroom-area');
            const originalBg = element.style.backgroundColor;
            element.style.backgroundColor = "#050505";
            html2canvas(element, {
                scale: 3,
                backgroundColor: "#050505",
            }).then(canvas => {
                element.style.backgroundColor = originalBg;
                const link = document.createElement('a');
                link.download = `SEAT_LAYOUT_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }
    </script>
</body>
</html>
